---
title: "Final project starter script"
author: "Phoebe Li, Lingqin Yang, Xingyue Jiang. Group 2 "
date: ''
output: html_document
---

#### Package loading

```{r global-options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(knitr)
library(dplyr)
library(Hmisc)
```


#### Importing the data

```{r}
# Import starting data
nlsy <- read_csv("http://www.andrew.cmu.edu/user/achoulde/94842/final_project/nlsy97/nlsy97_Nov2020.csv")

```

#### Variables present in the base data set

To learn more about the data, you can have a look at the [variable codebook file](http://www.andrew.cmu.edu/user/achoulde/94842/final_project/nlsy97/nlsy97_codebook.txt).


Here's how to rename all the variables to the Question Name abbreviation.  **You will want to change the names to be even more descriptive**, but this is a start.

```{r}
# Change column names to question name abbreviations (you will want to change these further)
colnames(nlsy) <- c("PSTRAN_GPA.01_PSTR",
    "INCARC_TOTNUM_XRND",
    "INCARC_AGE_FIRST_XRND",
    "INCARC_LENGTH_LONGEST_XRND",
    "PUBID_1997",
    "YSCH-36400_1997",
    "YSCH-37000_1997",
    "YSAQ-010_1997",
    "YSAQ-369_1997",
    "YEXP-300_1997",
    "YEXP-1500_1997",
    "YEXP-1600_1997",
    "YEXP-1800_1997",
    "YEXP-2000_1997",
    "sex",
    "KEY_BDATE_M_1997",
    "KEY_BDATE_Y_1997",
    "PC8-090_1997",
    "PC8-092_1997",
    "PC9-002_1997",
    "PC12-024_1997",
    "PC12-028_1997",
    "CV_AGE_12/31/96_1997",
    "CV_BIO_MOM_AGE_CHILD1_1997",
    "CV_BIO_MOM_AGE_YOUTH_1997",
    "CV_CITIZENSHIP_1997",
    "CV_ENROLLSTAT_1997",
    "CV_HH_NET_WORTH_P_1997",
    "CV_YTH_REL_HH_CURRENT_1997",
    "CV_MSA_AGE_12_1997",
    "CV_URBAN-RURAL_AGE_12_1997",
    "CV_SAMPLE_TYPE_1997",
    "CV_HGC_BIO_DAD_1997",
    "CV_HGC_BIO_MOM_1997",
    "CV_HGC_RES_DAD_1997",
    "CV_HGC_RES_MOM_1997",
    "race",
    "YSCH-6800_1998",
    "YSCH-7300_1998",
    "YSAQ-372B_1998",
    "YSAQ-371_2000",
    "YSAQ-282J_2002",
    "YSAQ-282Q_2002",
    "CV_HH_NET_WORTH_Y_2003",
    "CV_BA_CREDITS.01_2004",
    "YSAQ-000B_2004",
    "YSAQ-373_2004",
    "YSAQ-369_2005",
    "CV_BIO_CHILD_HH_2007",
    "YTEL-52~000001_2007",
    "YTEL-52~000002_2007",
    "YTEL-52~000003_2007",
    "YTEL-52~000004_2007",
    "CV_BIO_CHILD_HH_2009",
    "CV_COLLEGE_TYPE.01_2011",
    "CV_INCOME_FAMILY_2011",
    "CV_HH_SIZE_2011",
    "CV_HH_UNDER_18_2011",
    "CV_HH_UNDER_6_2011",
    "CV_HIGHEST_DEGREE_1112_2011",
    "CV_BIO_CHILD_HH_2011",
    "YSCH-3112_2011",
    "YSAQ-000A000001_2011",
    "YSAQ-000A000002_2011",
    "YSAQ-000B_2011",
    "YSAQ-360C_2011",
    "YSAQ-364D_2011",
    "YSAQ-371_2011",
    "YSAQ-372CC_2011",
    "YSAQ-373_2011",
    "YSAQ-374_2011",
    "YEMP_INDCODE-2002.01_2011",
    "CV_BIO_CHILD_HH_2015",
    "YEMP_INDCODE-2002.01_2017",
    "YEMP_OCCODE-2002.01_2017",
    "CV_MARSTAT_COLLAPSED_2017",
    "YINC-1400_2017",
    "income",
    "YINC-1800_2017",
    "YINC-2400_2017",
    "YINC-2600_2017",
    "YINC-2700_2017",
    "CVC_YTH_REL_HH_AGE6_YCHR_XRND",
    "CVC_SAT_MATH_SCORE_2007_XRND",
    "CVC_SAT_VERBAL_SCORE_2007_XRND",
    "CVC_ACT_SCORE_2007_XRND",
    "CVC_HH_NET_WORTH_20_XRND",
    "CVC_HH_NET_WORTH_25_XRND",
    "CVC_ASSETS_FINANCIAL_25_XRND",
    "CVC_ASSETS_DEBTS_20_XRND",
    "CVC_HH_NET_WORTH_30_XRND",
    "CVC_HOUSE_VALUE_30_XRND",
    "CVC_HOUSE_TYPE_30_XRND",
    "CVC_ASSETS_FINANCIAL_30_XRND",
    "CVC_ASSETS_DEBTS_30_XRND")

### Set all negative values to NA.  
### THIS IS DONE ONLY FOR ILLUSTRATIVE PURPOSES
### DO NOT TAKE THIS APPROACH WITHOUT CAREFUL JUSTIFICATION
nlsy[nlsy < 0]  <- NA
```

#### A note on missing values

Here's an example of what the variable description files look like

```
T76400.00    [YSAQ-372CC]                                   Survey Year: 2011
  PRIMARY VARIABLE

 
             HAS R USED COCAINE/HARD DRUGS SINCE DLI?
 
Excluding marijuana and alcohol, since the date of last interview, have you used
any drugs like cocaine, crack, heroin, or crystal meth, or any other substance 
not prescribed by a doctor, in order to get high or to achieve an altered state?
 
UNIVERSE: All except prisoners in an insecure environment
 
     215       1 YES   (Go To T76401.00)
    7023       0 NO
  -------
    7238
 
Refusal(-1)           74
Don't Know(-2)        26
TOTAL =========>    7338   VALID SKIP(-4)      85     NON-INTERVIEW(-5)    1561
 
Min:              0        Max:              1        Mean:                 .03
 
Lead In: T76397.00[Default] T76399.00[Default]  T76398.00[0:0]
Default Next Question: T76403.00
```

This description says that the numbers -1, -2, -4 and -5 all have a special meaning for this variable.  They denote different types of missingness.  You can recode all of these to `NA`, but you should also think about whether the different missigness indicators are in some way informative.  (i.e., if someone refuses to answer questions related to drug use, might this inform us about their income?) 

#### Getting to know our two main variables.

In the previous chunk of code we have appropriately renamed the variables corresponding to `sex`, `race` and `income` (as reported on the 2017 survey).  Let's have a quick look at what we're working with.

```{r}
table(nlsy$sex)

table(nlsy$race)
```

The data codebook tells us that the coding for sex is `Male = 1`, `Female = 2`.  For the race/ethnicity variable, the coding is:

```
1 Black
2 Hispanic
3 Mixed Race (Non-Hispanic)
4 Non-Black / Non-Hispanic
```

You'll want to do some data manipulations to change away from the numeric codings to more interpretable labels. 

```{r}
summary(nlsy$income)

# Histogram
qplot(nlsy$income)
```

The income distributing is right-skewed like one might expect.  However, as indicated in the question description, the income variable is *topcoded* at the 2% level.  More precisely,

```{r}
n.topcoded <- with(nlsy, sum(income == max(income, na.rm = TRUE), na.rm = TRUE))
n.topcoded
```

`r n.topcoded` of the incomes are topcoded to the maximum value of `r max(nlsy$income, na.rm = TRUE)`, which is the average value of the top `r n.topcoded` earners.    You will want to think about how  to deal with this in your analysis.


#### Data Processing and Summarization
Fo this project, we examined what factors could influence the income, specifically, we examined how gender would make a difference among these variables and income. The variables we checked are: income, sex, weed.use.97(EVER USE MARIJUANA?), hard.drug.use.98(EVER USE COCAINE/HARD DRUGS?), weed.use.00, weed.use.05, weed.use.11, hard.drug.use.11, industry, sat.math(SAT Math Score), education(Highest Degree), kid18(NUMBER OF HOUSEHOLD MEMBERS UNDER AGE 18), kid6(NUMBER OF HOUSEHOLD MEMBERS UNDER AGE 6).

```{r}
nlsy <- nlsy %>%
  rename(weed.use.97 = 'YSAQ-369_1997', 
         hard.drug.use.98 = 'YSAQ-372B_1998', 
         weed.use.00  = 'YSAQ-371_2000', 
         weed.use.05 = 'YSAQ-369_2005', 
         weed.use.11 = 'YSAQ-371_2011',
         hard.drug.use.11 = 'YSAQ-372CC_2011', 
         industry = 'YEMP_INDCODE-2002.01_2017', 
         sat.math = 'CVC_SAT_MATH_SCORE_2007_XRND', 
         education = 'CV_HIGHEST_DEGREE_1112_2011', 
         kid18 = 'CV_HH_UNDER_18_2011', 
         kid6 = 'CV_HH_UNDER_6_2011')


```

### Income Across Sex in a quick view.
```{r}
income.t <- t.test(income ~ sex, data = nlsy)
income.t
```

*When we run the t-test, we found that there is a significant different between in income between women and men. And men is usually earn more than women. To furture analysis what cause the income gap, we decided to analysis this quetino using: drug-use, education, industry and number of children they have.*


#### Methodology
In general, we conduct t-test, and regression analysis. In different cases, we obvserve if the NA value is informatic or not to decided to keep it or not. For example, we decided to drop all the NA value in binary varibale in drug use table. Becuase we cannot make sure the person use weed will use hard drug. For the topcoded variables, we run the regression with and without the topcoded variable seperatly to see is the coefficient difference is significant.

### Drug Use

```{r}
myvars <- c('hard.drug.use.98', 'weed.use.00', 'hard.drug.use.11', 'sex', 'income')

drug.use <- nlsy[myvars]

drug.use <- drug.use %>%
  mutate(sex = case_when(
    sex ==1 ~ 'Male', sex == 2 ~ 'Female'
  ))

drug.use <- drug.use %>% drop_na(income)
drug.use <- drug.use %>% drop_na(weed.use.00)
drug.use <- drug.use %>% drop_na(hard.drug.use.98)
drug.use$weed.use.00 <- as.numeric(drug.use$weed.use.00)
drug.use$income <- as.numeric(drug.use$income)
cbp2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

```

```{r}
drug.use<-drug.use[!(drug.use$income==0),]

kable(summary(drug.use))

```

```{r}
drug.use$hard.drug.use.11[drug.use$hard.drug.use.98==1 & is.na(drug.use$hard.drug.use.11)] <- 1

drug.use$hard.drug.use.11[drug.use$hard.drug.use.98==0 & is.na(drug.use$hard.drug.use.11)] <- 0

drug.use
```

Logic for the data clearning: Since there are significant number of weed.use.00 is missing, `sum(is.na(drug.use$weed.use.00))`, so that the income are not predicable via drug usage and sex. In this case, we decided to drop the NA income value. Besides, we decided to drop the binary NA, which is in weed.use.07, and hard.drug.use.98 and hard.drug.use 11. For the hard.drug.use.11 we expected that the people who use hard.drug in 1998 will continue use it at 2011. In addition, we decided to change the weed usage to the numeric, to help us conduct the t-test and construct the plots.

#### 1. General statitically analysis
```{r}
p1 <- ggplot(data = drug.use, aes(x = weed.use.00, y = income)) + geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Weed-use Against Income') + ylim(0,235885) + stat_smooth()
p1

weed.g <- ggplot(drug.use, aes(x=weed.use.00, y=income)) + facet_grid(rows = vars(sex)) + geom_point() + stat_smooth()

weed.g



```

*We can see that people not or light use weed are more likley to get higher income.Because we can see the points are more density at the low weed use level. We also see the regression line has downward trend. The trend is same in two gender groups. However, since the regression line is not significnat through the graph, we decided to conduct more analysis. *

```{r}
drug.use <- drug.use %>%
  mutate(high.earn = case_when(
    income >= 100000 ~ 1, 
    income < 100000 ~ 0
  ))
  

```
*To further analysis the weed usage affect the income, we define the new variable high-income is the income is larger than 100000*

```{r}
detail.sum.0<- drug.use %>%
  group_by(sex) %>%
  summarise(count = n(), hard.drug.use.rate = sum(hard.drug.use.11)/n(), avg.weed = mean(weed.use.00))
  
kable(detail.sum.0)

```
*We found that Male has higher hard.drug use.rate and average weed usage. *

```{r}
detail.sum<- drug.use %>%
  group_by(sex, hard.drug.use.11) %>%
  summarise(count = n(), high.earn.rate = sum(high.earn == 1) / n())
  
kable(detail.sum)

```

*Surprisingly, we found that female who use the hard.drug have higher high.earn.rate (indicating they are more financially abundent) than female who don't use the hard.drug. In contrast, male who use the hard.drug has the lower high earn rate than the male who don't use the hard.drug. *

```{r}
detail.sum.2<- drug.use %>%
  group_by(sex, weed.use.00, hard.drug.use.11) %>%
  summarise(count = n(), high.earn.rate = sum(high.earn == 1) / n())
  

earn.weed <- ggplot(data = detail.sum.2, aes(x = weed.use.00, y = high.earn.rate, fill=sex))

earn.weed + geom_bar(stat="identity") + facet_grid(rows = vars(sex), cols = vars(hard.drug.use.11)) + xlab("Weed Usage") + ylab("High Income Rate")

```

*In this graph, we found out that the Female hard.drug user tend to use less weed. And male hard drug users tend to be highly relying on weed. We also find that hard.drug user has high higher.income rate which is not consistent as our expect. *

#### 2. T-test & regression analysis. 
```{r}
drug.t <- t.test(weed.use.00 ~ sex, data = drug.use)
drug.t

lm.fit.1 <- lm(income ~ weed.use.00, data = drug.use)
summary(lm.fit.1)

drug.use.top <-drug.use[!(drug.use$income == 235884),]
lm.fit.2 <- lm(income ~ weed.use.00, data = drug.use.top)
summary(lm.fit.2)
```

```{r}
plot(lm.fit.2)
```

***Residuals vs. Fitted***
There is a clear indication of linearity present in this plot. the residuals will have constant variance when plotted against fitted values; and the residuals and fitted values will be uncorrelated.
***Normal QQ plot***
We can see that is has two tail, so that it's not normal.
***Scale-location plot***
We see a a horizontal line in residual variance that runs through most of the plot. 

***Residuals vs Leverage***
None of the points appear to be outliers.

*We see that there is a strong difference between men and women in weed usage. The low P-value (Below 0.05) indicating stiaticial significance. Without inclduing with topcoded, we find that the weed usage will decrease the income. And the p-value is less than 0.05, so that it's statistically significant. Then we run another regression without the topcoded income. By removing the topcoded income, we noticed a huge change with the estimator (from -304.1 to 360.12) with the decreasing p-value and increasing f-stats. So we decided to used the second method as our final regression model. *

#### 3.Summary with adjustment

```{r}
drug.use.ad <- drug.use[!(drug.use$income == 235884),]
drug.use.ad
weed.g.ad <- ggplot(drug.use.ad, aes(x=weed.use.00, y=income)) + facet_grid(rows = vars(sex)) + geom_point() + stat_smooth() + ylim(0,230000)
#weed.g.ad

drug.t.ad <- t.test(weed.use.00 ~ sex, data = drug.use.ad)
drug.t.ad


```

```{r}
drug.use <- drug.use %>%
  mutate(weed.use = case_when(
    weed.use.00 <= 6 ~ 'Light-Use', 
    weed.use.00 <= 12 ~ 'Mid-light-Use', 
    weed.use.00 <= 18 ~ 'Mid-Use', 
    weed.use.00 <= 24 ~ 'Avg-Use', 
    weed.use.00 <=30 ~ 'Heavey-Use'
  ))

drug.use
```

*Regenerate the weed use to 5 different level.*

```{r}
gap.data.conf <- drug.use %>%
  group_by(weed.use) %>%
  summarise(income.gap = mean(income[sex == "Male"], na.rm = TRUE) -
              mean(income[sex == "Female"], na.rm = TRUE),
            upper = -t.test(income ~ sex)$conf.int[1],
            lower = -t.test(income ~ sex)$conf.int[2],
            is.significant = as.numeric(t.test(income ~ sex)$p.value < 0.05))

gap.data.conf <- mutate(gap.data.conf,
                        weed.use = reorder(weed.use, income.gap))

ggplot(data = gap.data.conf, aes(x = weed.use, y = income.gap,
                            fill = is.significant)) +
  geom_bar(stat = "identity") +
  xlab("weed.use") + 
  ylab("Income gap($)") +
  ggtitle("Income gap between men and women, by Weed Use") + 
  guides(fill = FALSE) +
  geom_errorbar(aes(ymax = upper, ymin = lower), width = 0.1, size = 1) +
  theme(text = element_text(size=12)) 

```
*Finally, we find that only mid-use and avg-use, the income gap are significant between men and women. The higher the drug usage, the wider the income gap becomes.*

***Findings***
We find that only mid-use and avg-use, the income gap are significant between men and women. And the the durg use higher, the income gap are higher.

***Discussion***
Since the normal-qq plot indicates that it's not normal distributed, we believe that our sample size might be too small. And we are 95% confident about our result in this section. 


### Children

#### 1.Income and Household Children Number

```{r}
myvars.2 <- c('kid18', 'kid6','sex', 'income')

kid <- nlsy[myvars.2]

kid <- kid %>%
  mutate(sex = case_when(
    sex ==1 ~ 'Male', sex == 2 ~ 'Female'
  ))

```

```{r}
kid <- kid %>% drop_na(income)
kid <- kid %>% drop_na(kid6)
kid <- kid %>% drop_na(kid18)
kid$income <- as.numeric(kid$income)

```

In this step, we changes the right column name and drop the NAs.

##### Brief Summaries
```{r}
kid18<- kid %>%
  group_by(sex,kid18) %>%
  summarise(count = n(), avg.income = mean(income))
  
kable(kid18)

```

*For househould Children (under 18) amount, we can see kids amount over 15 is relatviely rare. Female group tends to have more kids. Also, in every children amount group, male earns higher than female.*

```{r}
kid6<- kid %>%
  group_by(sex,kid6) %>%
  summarise(count = n(), avg.income = mean(income))
  
kable(kid6)

```

Children (under 6) Household : As we can see, the kids under 6 amount is scatterd around 0-2. The difference between male and female in having different amount of children is not as large as the under 18 group. 

However, female still earns lower than male. 

Here we can make an assumption that the children amount will negatively affect the income.

```{r}
kid18.1 <- ggplot(data = kid, aes(x = kid18, y = income)) + geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Household for Children under 18 Against Income')  
kid18.1

```

```{r}
kid6.1 <- ggplot(data = kid, aes(x = kid6, y = income)) + geom_point(stat='identity', color = 'darkgreen') +
  ggtitle('Household for Children under 6 Against Income')  
kid6.1

```

The two graphs have suggest the same as summary table.The more children they have, less they made in work. And children under 18 group's effect is mucha larger.

Let's see the income gap when combining sex.

```{r}
kid18.2 <- ggplot(data = kid, aes(x = kid18, y = income)) + geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Industry Type Against Income') + ylim(0,235885) + facet_wrap(~sex,scales = "free_y")
kid18.2

kid6.2 <- ggplot(data = kid, aes(x = kid6, y = income)) + geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Industry Type Against Income') + ylim(0,235885) + facet_wrap(~sex,scales = "free_y")
kid6.2

```

We can see although male and female's income both affected by kid number, the influence on female is much more obvious.

Set up the high-income.

```{r}
kid <- kid %>%
  mutate(high.earn = case_when(
    income >= 100000 ~ 1, 
    income < 100000 ~ 0
  ))
```



##### T-test and Linear regression
```{r}
 kid18.t<- t.test(kid18 ~ sex, data = kid)
kid18.t
```


```{r}
 kid6.t<- t.test(kid6 ~ sex, data = kid)
kid6.t
```

We can see in group children under 18, number of kid under 18~sex has a statistacal significance with p value less than 0.05. While in group children under 6, such significance does not exist.


Let's run a linear regression to see how it relates with income. 

```{r}
lm.kid18.1 <- lm(income ~kid18, data = kid)
summary(lm.kid18.1)

kid.top <-kid[!(kid$income == 235884),]
lm.kid18.2 <- lm(income ~ kid18, data = kid.top)
summary(lm.kid18.2)
```

We can see that the topcoded model is more accurate with a obviously different coefficients. In both model, the number of kids under 18 can affect the income negatively with a statistically significance.

Using the data from the second model, we can see that with one more under 18 kids in the family, the average income will decrease by 4151 dollars.

```{r}
lm.kid6.1 <- lm(income ~kid6, data = kid)
summary(lm.kid6.1)

kid.top <-kid[!(kid$income == 235884),]
lm.kid6.2 <- lm(income ~ kid6, data = kid.top)
summary(lm.kid6.2)
```

We can see that the top coded model is more accurate with a obviously different coefficients. In model 1, the number of kids under 6 can affect the income negatively with a statistically significance. However, in model 2, it's not statistically siginificant.

If we use the data from the first model, we can see that with one more under 6 kids in the family, the average income will decrease by 2897 dollars.

```{r}
plot(lm.kid18.2)
```
```{r}
plot(lm.kid6.2)
```

We can see both model plots has meet the requirement of constant variance, a normal QQ plot and no out liers in the leverage plot. 

***Summary***
*Children Household(under 18+under6)/Income:*
To start with, we have two numeric variables of Children Household(under 18) and Children Household(under6). 
To get an overview of the data, we have scatter plots and tabular summaries. We find out that for household Children (under 18) amount, we can see kids amount over 15 is relatively rare. Female group tends to have more kids.The kids under 6 amount is around 0-2. The difference between male and female in having different amount of children is not as large as the under 18 group. In both groups, female earns lower than male. To sum up, the less kids they have, the higher the income is. We can see although male and female's income both affected by kid number, the influence on female is much more obvious. In kids under 18 group, the effect is more obvious. 
We first run t test kid18/kid6~sex. In group of children under 18, the household children number is statistically effected by sex with a p value less than 0.05. In the group under 6, the significance doesn't exist. 
Running linear regressions for both groups.The number of kids under 18 can affect the income negatively with a statistically significance.With one more under 18 kids in the family, the average income will decrease by 4151 dollars.However, in the group under 6, there is no statistically significance if using the top coded model. 
Limitations for this variable research may be it could also have confounding variables. Does marital status also have an influence? Further correlation study needs to be conducted.

### Industry

#### 1. Income and Industry Type

```{r}
myvars.3 <- c('industry', 'sex', 'income')

prof <- nlsy[myvars.3]

prof <- prof %>%
  mutate(sex = case_when(
    sex ==1 ~ 'Male', sex == 2 ~ 'Female'
  ))

```

```{r}
prof <- prof %>%
  
    mutate(physical = case_when(
    industry =  industry>370 & industry <690 ~ 1, 
    industry== 770 ~ 1,
    industry>1070 & industry <3990 ~ 1,
     industry>6070& industry<6090 ~ 1,
    industry>4070 & industry<5790  ~0,
 industry>6870 &industry<7190~ 0,
   industry >7860 & industry < 8470  ~ 0,
 industry >9370 & industry < 9590 ~ 0,
  industry >8560 &industry<8690 ~ 0,
  industry>6470& industry<6780 ~ 0,
   industry> 7270 & industry< 7790 ~0,
 industry >8770 & industry< 9290 ~0
  ))
```

```{r}
 prof <- prof %>% 
mutate(industry = case_when(
  industry>370 & industry <690 ~'industrial',
   industry== 770 ~'construction',
   industry>1070 & industry <3990 ~'manufacturing',
  industry>6070& industry<6090 ~ 'transportation',
 industry>4070 & industry<5790  ~'trade finance',
 industry>6870 &industry<7190~ 'trade finance',
   industry >7860 & industry < 8470  ~ 'social services',
 industry >9370 & industry < 9590 ~ 'administration',
  industry >8560 &industry<8690 ~ 'recreational',
  industry>6470& industry<6780 ~ 'recreational',
   industry> 7270 & industry< 7790 ~'professional service',
 industry >8770 & industry< 9290 ~'professional service'
   ))
```

In this step, we changed proper column names and mutated numeric variables within ranges to categorical variables. We dropped some small-size industry types, like arts (contain 0 people), and combine some industry types together , like  wholesale trade and retail trade can be both categorized as trade. We also add a new column physial, in case we need to analyze from a broader level.(1 when working in industries requiring physical work, 0 when not)

```{r}

prof <- prof %>% drop_na(income)
prof <- prof %>% drop_na(industry)
prof <- prof %>% drop_na(physical)
prof$income <- as.numeric(prof$income)
```

Then,Drop the null value.


##### Brief Summaries
```{r}

prof.1 <- ggplot(data = prof, aes(x = industry, y = income)) + geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Industry Type Against Income')  +theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
prof.1

```

```{r}

prof.2 <- ggplot(data = prof, aes(x = sex, y = income)) + geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Sex Against Income in Different Industries') +  facet_wrap(~industry,scales = "free_y")+theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
prof.2


```




```{r}
prof.3 <- ggplot(data = prof, aes(x = industry, y = income)) + geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Industry Type Against Income') + ylim(0,235885) + facet_wrap(~sex,scales = "free_y")+theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
prof.3


```


From the 3 graphs above, we could observe if the income varies in different industries, and income gap with combined industry/sex.

Transportation is certainly an outlier. But with transportation's salaries relatively fixed, we can still observe a gap between female and male. Also, there is an income gap between male and female in construction, industrial and manufacturing. 

Therefore, we tried to make a hypothesis that women earn less in the industries with more physicial work. Let's sort the industry into "physical"/"non-phyisical".

```{r}
prof.4 <- ggplot(data = prof, aes(x = sex, y = income)) + geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('physical/non physical industries difference by sex') + ylim(0,235885) + facet_wrap(~physical,scales = "free_y")+theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
prof.4
  
```

```{r}
physical<- prof %>%
  group_by(sex,physical) %>%
  summarise(count = n(), avg.income = mean(income))
  
kable(physical)

  
```

We can see that female working in the industries requiring physical work is much fewer than men working in those industries. However, the gap between men and women in physical/non-physical is relatively close. Surprisingly, the gap in non-physical is much larger regarding average salaries.

```{r}
industry<- prof %>%
  group_by(sex,industry) %>%
  summarise(count = n(), avg.income = mean(income))
  
kable(industry)

  
```

With this table, the previous findings may make more sense. The people in transportation and industrial is very few and can't used for analytics as a single group.  In every industry, male have a higher out come than female.

Conflicting to our previous assumption, in non-physical sector, each industries has shown a much higher avg.income.

##### Regression and T test

```{r}
 physical.t<- t.test(physical ~ sex, data = prof)
physical.t
```


We do find a statistically difference with p value less than 0.05. By running t test, sex is a factor that will influence people'choice in entering phycial/non-physical industry.

```{r}
lm.phy.1 <- lm(income ~physical, data = prof)
summary(lm.phy.1)

prof.top <-prof[!(prof$income == 235884),]
lm.phy.2 <- lm(income ~ physical, data = prof.top)
summary(lm.phy.2)
```

We can see that there is an obvious difference in coefficient regarding whether we use topcoded value. 
But by both means, the phyisal/non physical status of industries influence the income with a statistical significance.
Applying the second model, when the physical industry is 5314.5 dollar lower than non-physical industries by average income.

```{r}
lm.phy.3 <- lm(income ~industry, data = prof)
summary(lm.phy.3)

prof.top <-prof[!(prof$income == 235884),]
lm.phy.4 <- lm(income ~ industry, data = prof.top)
summary(lm.phy.4)
```

We can see the difference between the two models is smaller when we comes to detailed industries.
While we finds that the industries physical/non-physical is influecing the income, the model by industries doens't show statistically significance in transportation, industrial and manufacturing. So we need to adjust our conclusion to in the manufacturing industry,the income is significantly infuenced. 
The industry that will influence the income significantly also include: recreational and social services.


```{r}
plot(lm.phy.4)
```

```{r}
plot(lm.phy.2)
```

We can see both model plots has meet the requirement of constant variance, a normal QQ plot and no out liers in the leverage plot. 

***Summary***
*Industry/Income:*
First, we dropped some small-size industry types, like arts (contain 0 people), and combine some industry types together, like  wholesale trade and retail trade can be both categorized as trade. We also add a new column physical, in case we need to analyze from a broader level.(1 when working in industries requiring physical work, 0 when not)
From a tabular summary and scatter plots, we noticed that there is an income difference across industries. We also there is sexual gap in amount of female/male working in different industries.
To be more detailed, we should compare the non-physical/physical industries, to see if this is a factor influencing the sexual gap across industries.
By running a t test of physical~sex, we find a p value less than 0.05.This confrims our assumption that sex influences female/male's career choices for industries require physical work.
By running linear regressions on income~physical and income~industries, we find that whether the industries requiring physical work influence income, but not every industry type have a statistically significant effect on income. 
Plotting the diagnostics plots, the requirement of constant variance, a normal QQ plot and no outliers are satisfied.
Limitations may be that the industry sizes in each categories are varied. If further research could run a randomized trials controlling the factors other than industries, the conclusion might be more convincing.



### School

#### Methodology of Education

##### 1. Data
We first recoded numeric type back to description. Then we added a new variable as bachelor, which sets lower than bachelor's degree as 0, and bachelor above degrees as 1. There is a small size group as PhD, but since it is actually a very important degree, so we still leave it in the data. We remove any missing values.

##### 2. Explotary Analysis
From tabular summary, scatter plots and box plots, we can observe that there is a difference by income across degree types. We also observed that there is a income gap between female and male in every degree type.

##### 3. Regression and T test
To explore further, we compared the Bachelor-above/Bachelor-below degrees, to see if this is a factor influencing the income.By running a t-test of bachelor~sex, we find a p value less than 0.05. This confrims our assumption that bachelor degree above or below influences income. By running linear regressions on income~bachelor and income~education, we find that whether achieved Bachelor's degree influence income, but degrees below Bachelor does not have a statistically significant effect on income. Plotting the diagnostics plots, the requirement of constant variance, a normal QQ plot and no outliers are satisfied.


#### 1. Income and Education

##### Data Cleaning and Processing
```{r}
eduvars <- c('sex','income','sat.math','education')
edu <- nlsy[eduvars]

edu <- edu %>%
  mutate(sex = case_when(
    sex == 1 ~ 'Male', sex == 2 ~ 'Female'
  ))

edu <- edu %>%
  mutate(bachelor = case_when(
    education == 0 ~ 0,
    education == 1 ~ 0,
    education == 2 ~ 0,
    education == 3 ~ 0,
    education == 4 ~ 1,
    education == 5 ~ 1,
    education == 6 ~ 1,
    education == 7 ~ 1
  ))

edu <- edu %>%
  mutate(education = case_when(
    education == 0 ~ 'None',
    education == 1 ~ 'GED',
    education == 2 ~ 'High school diploma',
    education == 3 ~ 'Associate or Junior college',
    education == 4 ~ 'Bachelor',
    education == 5 ~ 'Master',
    education == 6 ~ 'PhD',
    education == 7 ~ 'Professional'
  ))

edu <- edu %>%
  mutate(sat.math = case_when(
    sat.math == 1 ~ '200-300',
    sat.math == 2 ~ '301-400',
    sat.math == 3 ~ '401-500',
    sat.math == 4 ~ '501-600',
    sat.math == 5 ~ '601-700',
    sat.math == 6 ~ '701-800'
  ))

```

Recode variables from numeric category back to their string category. Also, for education, add "bachelor" which set lower than bacelor degree as 0, and bachelor above degree as 1.


```{r}
edu <- mutate(edu, education = factor(education,
                                      levels = c('None',
                                                 'GED',
                                                 'High school diploma',
                                                 'Associate or Junior college',
                                                 'Bachelor',
                                                 'Master',
                                                 'PhD',
                                                 'Professional'
                                      )))
edu <- mutate(edu, sat.math = factor(sat.math,
                                     levels = c('200-300','301-400','401-500','501-600','601-700','701-800')))
```

Set up factor levels.


```{r}
edu <- edu %>% drop_na(income)
edu <- edu %>% drop_na(education)
edu <- edu %>% drop_na(sat.math)
edu
```
Drop missing values from income, education, and SAT Math Scores.  

  
##### Brief Summaries - Education

```{r}
edu.1 <- qplot(data = edu, x = education, y = income, geom = "boxplot", group = education) +
  ggtitle('Highest Degree Against Income') +
  theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
edu.1
```
As can be seen from the figure, the higher the highest degree, the higher the income.

```{r}
edu.2 <- ggplot(data = edu, aes(x = sex, y = income), geom = 'boxplot') + 
  geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Sex Against Income with Different Degrees') + 
  facet_wrap(~education,scales = "free_y")
edu.2

edu.2.1 <- qplot(data = edu, x = sex, y = income, geom = "boxplot", group = sex) +
  ggtitle('Sex Against Income with Different Degrees') + facet_wrap(~education,scales = "free_y")
edu.2.1
```
There are two plots here, one scatterplot, and one boxplot, as boxplot is more straightforward for comparison but sometimes there are too few data to be accurate like in PhD here, so two methods are adopted.

**There are too few data in PhD, so the data of PhD could not be used for analytics. And as shown in each degree plot, male always has higher income than female. It is most obvious in None and GED degree.**

```{r}
edu.3 <- ggplot(data = edu, aes(x = education, y = income)) + 
  geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Highest Degree Against Income') + 
  ylim(0,235885) + 
  facet_wrap(~sex,scales = "free_y")+
  theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
edu.3

edu.3.1 <- qplot(data = edu, x = education, y = income, geom = "boxplot", group = education) +
  ggtitle('Highest Degree Against Income') + facet_wrap(~sex,scales = "free_y") +
  theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
edu.3.1
```
Same as the above, we added boxplot to better view comparison.

From the 3 graphs above, we could observe if the income varies with highest degrees, and income gap with combined education/sex.

**We can observe that generally male earns more with equivalent highest degrees, and such is more obvious when Associate/High school diploma or lower degree is earned.**

Therefore, we tried to make a hypothesis that women earn less with highest degree lower than Bachelor. Let's sort the education into "Bachelor/lower-than-Bachelor".

##### Hypothesis on Bachelor/Lower-than-Bachelor Degree

```{r}
edu.4 <- ggplot(data = edu, aes(x = sex, y = income)) + 
  geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Bachelor/lower-than-Bachelor difference by sex') + 
  ylim(0,235885) + 
  facet_wrap(~bachelor,scales = "free_y")+
  theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
edu.4

edu.4.1 <- qplot(data = edu, x = sex, y = income, geom = "boxplot", group = sex) +
  ggtitle('Bachelor/lower-than-Bachelor difference by sex') + facet_wrap(~bachelor,scales = "free_y")
edu.4.1
```
The plots showed that whether bachelor degree was earned or lot, male has higher income.

```{r}
bachelor <- edu %>%
  group_by(sex, bachelor) %>%
  summarise(count = n(), avg.income = mean(income), .groups='keep')
```
```{r}
kable(bachelor)
```

We check again with table.
We can see that female with degrees lower than Bachelor earns much lower than same degree male. Surprisingly, the gap in Bachelor and above degrees is much larger regarding average income.

```{r}
degrees<- edu %>%
  group_by(sex, education) %>%
  summarise(count = n(), avg.income = mean(income), .groups = 'keep')
```
```{r}
kable(degrees)
```

With this table, the previous findings may make more sense. With every degree, male have a higher income than female. In Professional, the gap is the smallest. PhD group is too small to be meaningful for analysis. 
Conflicting to our previous assumption, each degree has shown higher avg.income for male. So we check further with regression and T test.

##### Regression and T test

```{r}
bachelor.t <- t.test(bachelor ~ sex, data = edu)
bachelor.t
```

We do find a statistically difference with p value less than 0.05. From the t test, sex is a factor that influence people's income when non-Bachelor degree is earned.  


```{r}
lm.bachelor.1 <- lm(income ~bachelor, data = edu)
summary(lm.bachelor.1)
```

Since p value less than 0.05, we can say that bachelor degree lower or above would significantly influence the income.  

```{r}
plot(lm.bachelor.1)
```

We can see from the Residual vs Fitted plot that it remains a very slight indication of non-linearity.The Normal QQ plot: The residuals depart significantly from the diagonal line in upper tail of the distribution. This indicates that the residuals are not normally distributed. Interestingly, they appear to be more highly concentrated around upper corner than you would expect from the normal (i.e., they have lighter tails than a normal).  

```{r}
edu.general <- edu[!(edu$income == 235884),]
lm.edu.2 <- lm(income ~bachelor, data = edu.general)
summary(lm.edu.2)
```

We can see that there is an obvious difference in coefficient regarding whether we use topcoded value. But by both means, the Bachelor/lower-than-Bachelor status influences the income with a statistical significance. Applying the second model, when the Bachelor or above degree is 20909 dollar higher than non-Bachelor industries by average income.  

```{r}
plot(lm.edu.2)
```

We can see from the Residual vs Fitted plot that it shows clear linearity.The Normal QQ plot: The residuals depart significantly from the diagonal line in upper tail of the distribution. This indicates that the residuals are not normally distributed.  



```{r}
lm.edu.3 <- lm(income ~education, data = edu)
summary(lm.edu.3)
```

We do find a statistically difference with p value less than 0.05. From the regression, Bachelor and above degrees(Bachelors, Masters, PhD, Professional) is a factor that influence people's income when non-Bachelor degree is earned. We can see that for each of them, people could earn 46715, 54824, 61807, and 130467 more than None degree.  


```{r}
plot(lm.edu.3)
```

We can see from the Residual vs Fitted plot that it remains a very slight indication of non-linearity.The Normal QQ plot: The residuals depart significantly from the diagonal line in upper tail of the distribution. This indicates that the residuals are not normally distributed.   

```{r}
lm.edu.4 <- lm(income ~education, data = edu.general)
summary(lm.edu.4)
```

We can see that there is an obvious difference in coefficient regarding whether we use topcoded value. We can see that between two models, difference between Professional, Master and Bachelor is the biggest. Showing that topcoded salaries are mostly earned by people with these high degrees. While we find that Bachelor degrees or not influence the income, the model by degrees does not show statistically significance in GED, High School, and Associate, showing again that degrees below Bachelor's degree do not distinguish between each other, and they do not affect the income, while Bachelor degree influences the income.   

```{r}
plot(lm.edu.4)
```

We can see from the Residual vs Fitted plot that it remains a very slight indication of non-linearity.The Normal QQ plot: The residuals depart significantly from the diagonal line in both lower and upper tail of the distribution. This indicates that the residuals are not normally distributed.

**Conclusion of Income and Education**
From the above analysis, we can see that for each degree type, male has higher income that female. And this more obvious in None and GED degree. We also checked whether Bachelor and above degrees could influence the income. After t-test and regression, we can say that Bachelor and above degrees can influence the income positively with statistical significance.


####  Methodology of SAT Math Scores

##### 1. Data
We first recoded numeric type back to description. Then remove any missing values

##### 2. Explotary Analysis
From tabular summary, scatter plots and box plots, we can observe that there is a difference by income across range of scores. We also observed that there is a income gap between female and male in every range.

##### 3. Regression and T test
By running linear regressions on income~sat.math, we find that whether achieved 500 in SAT score influence income, but score ranges below 500 do not have a statistically significant effect on income. Plotting the diagnostics plots, the requirement of constant variance, a normal QQ plot and no outliers are satisfied.



#### 2.Income and SAT Math Scores

##### Brief Summaries - SAT Math Scores

```{r}
sat.1 <- qplot(data = edu, x = sat.math, y = income, geom = "boxplot", group = sat.math) +
  ggtitle('SAT Math Score Against Income') +
  theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
sat.1
```

It is obvious to see the trend that, high SAT Math score, higher income in the future.

```{r}
sat.2 <- ggplot(data = edu, aes(x = sex, y = income), geom = 'boxplot') + 
  geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('Sex Against Income with Different SAT Math Scores') + 
  facet_wrap(~sat.math,scales = "free_y")
sat.2

sat.2.1 <- qplot(data = edu, x = sex, y = income, geom = "boxplot", group = sex) +
  ggtitle('Sex Against Income with Different SAT Math Scores') + facet_wrap(~sat.math,scales = "free_y")
sat.2.1
```

We can clearly see from the two plots that within same range of SAT Math Score, male earns higher than female.

```{r}
sat.3 <- ggplot(data = edu, aes(x = sat.math, y = income)) + 
  geom_point(stat='identity', color = 'darkgreen') + 
  ggtitle('SAT Math Score Against Income') + 
  ylim(0,235885) + 
  facet_wrap(~sex,scales = "free_y")+
  theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
sat.3
```

Here we check with each sex how income varies with SAT Math Score. Generally, the higher the SAT Math Score, the higher income.

```{r}
sat.3.1 <- qplot(data = edu, x = sat.math, y = income, geom = "boxplot", group = sat.math) +
  ggtitle('Highest Degree Against Income') + facet_wrap(~sex,scales = "free_y") +
  theme(axis.text.x=element_text(angle =-270, vjust = 0.5))
sat.3.1
```

It is interesting to see that after SAT Math score 500, male's income increases with higher score but female's income is consistent even lower with higher score.


```{r}
scores<- edu %>%
  group_by(sex, sat.math) %>%
  summarise(count = n(), avg.income = mean(income), .groups='keep')
```


```{r}
kable(scores)
```

With this table, the previous findings may make more sense. With every scope of scores, male have a higher income than female.


##### Regression
```{r}
lm.sat.1 <- lm(income ~sat.math, data = edu)
summary(lm.sat.1)
```

We find that scores over 500(501-600, 601-700, 701-800) have influence on income with statistical significance, p value smaller than 0.05.

```{r}
plot(lm.sat.1)
```

We can see from the Residual vs Fitted plot that it remains a slight indication of non-linearity.The Normal QQ plot: The residuals depart significantly from the diagonal line in upper tail of the distribution. This indicates that the residuals are not normally distributed.  

```{r}
lm.sat.2 <- lm(income ~sat.math, data = edu.general)
summary(lm.sat.2)
```

We can see that there is an obvious difference in coefficient regarding whether we use topcoded value. We can see between the two models, the difference in coefficients for score over 500 is the biggest. Showing that topcoded salaries are mostly earned by people with higher sat math scores. Also, onle sat scores over 500 showed statistically significance that it will influence the income. So we need to adjust our conclusion to: while SAT Math score is over 500, how high the score is will significantly influence the income. But when score is lower than 500, the score itself does not significantly influence the income.

```{r}
plot(lm.sat.2)
```

We can see from the Residual vs Fitted plot that it remains a very slight indication of non-linearity. The Normal QQ plot: The residuals depart significantly from the diagonal line in both lower and upper tail of the distribution. This indicates that the residuals are not normally distributed. 

#### Conclusion of Income and SAT Math Score
From the above analysis, we can see that for range of score, male has higher income that female. After t-test and regression, we can say that only score ranges over 501 can influence the income positively with statistical significance.



We are 95% confident about our analysis. We are also confident about our conclusions and findings.
Potential limitations might be that there is not enough data for PhD group in Education analysis, while PhD is a very important group to analyze. Also, there could be further more detailed exploration on each degree type/SAT score, regarding sexual income gap. Besides, the data is not normalized, which affect the result.






